# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Check if resouregroup exists
      env:
        RESGROUP: ${{ secrets.RESGROUP }}
      run: echo ::set-env name=RGEXISTS::az group exists --name $RESGROUP

    - name: Delete resource group if exists
      if: ${{ always() }}
      env:
        RESGROUP: ${{ secrets.RESGROUP }}
      run: az group delete --name $RESGROUP --yes

    - name: Create resource group
      env:
        REGION: ${{ secrets.REGION }}
        RESGROUP: ${{ secrets.RESGROUP }}
      run: |
        az group create --location $REGION --name $RESGROUP

    - name: Create network
      env:
        REGION: ${{ secrets.REGION }}
        RESGROUP: ${{ secrets.RESGROUP }}
        VNET: ${{ secrets.VNET }}
      run: |
        az network nsg create --name "vCD-VM-SecGrp" --resource-group $RESGROUP --location $REGION
        az network nsg create --name "vCD-console-SecGrp" --resource-group $RESGROUP --location $REGION
        az network vnet create --name $VNET --resource-group $RESGROUP --address-prefixes "10.255.0.0/24" --location $REGION


    - name: Allow SSH in
      env:
        RESGROUP: ${{ secrets.RESGROUP }}
      run: |
        az network nsg rule create --name "AllowInboundSSH" --nsg-name "vCD-VM-SecGrp" --priority 1000 --resource-group $RESGROUP --access Allow --destination-address-prefixes "*" --destination-port-ranges 22 --direction Inbound --protocol Tcp --source-address-prefixes "*" --source-port-ranges "*"
        az network nsg rule create --name "AllowInboundSSH" --nsg-name "vCD-console-SecGrp" --priority 1000 --resource-group $RESGROUP --access Allow --destination-address-prefixes "*" --destination-port-ranges 443 --direction Inbound --protocol Tcp --source-address-prefixes "*" --source-port-ranges "*"
      